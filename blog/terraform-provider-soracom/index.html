<!doctype html>
<html lang="ja-JP" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Terraform provider for SORACOM を作って Azure Functions と連携してみた | ks6088ts</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://github.com/ks6088ts.png"><meta data-rh="true" name="twitter:image" content="https://github.com/ks6088ts.png"><meta data-rh="true" property="og:url" content="https://ks6088ts.github.io/blog/terraform-provider-soracom"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Terraform provider for SORACOM を作って Azure Functions と連携してみた | ks6088ts"><meta data-rh="true" name="description" content="Terraform で SORACOM のリソース管理をしたかったので、SORACOM 向けの Terraform カスタムプロバイダを実装してみました。カスタムプロバイダ開発に係る知見や、Terraform provider for SORACOM で SORACOM のリソース管理をしてみた例をご紹介します。"><meta data-rh="true" property="og:description" content="Terraform で SORACOM のリソース管理をしたかったので、SORACOM 向けの Terraform カスタムプロバイダを実装してみました。カスタムプロバイダ開発に係る知見や、Terraform provider for SORACOM で SORACOM のリソース管理をしてみた例をご紹介します。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-12-10T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/ks6088ts"><meta data-rh="true" property="article:tag" content="terraform,azure"><link data-rh="true" rel="icon" href="https://github.com/ks6088ts.png"><link data-rh="true" rel="canonical" href="https://ks6088ts.github.io/blog/terraform-provider-soracom"><link data-rh="true" rel="alternate" href="https://ks6088ts.github.io/blog/terraform-provider-soracom" hreflang="ja-JP"><link data-rh="true" rel="alternate" href="https://ks6088ts.github.io/en/blog/terraform-provider-soracom" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://ks6088ts.github.io/blog/terraform-provider-soracom" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="ks6088ts RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="ks6088ts Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0ZTKFXVQ5K"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0ZTKFXVQ5K",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.92836a84.css">
<link rel="preload" href="/assets/js/runtime~main.7b63d5b9.js" as="script">
<link rel="preload" href="/assets/js/main.c82f993f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="https://github.com/ks6088ts.png" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="https://github.com/ks6088ts.png" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Home</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ks6088ts/ks6088ts.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近のブログ記事のナビゲーション"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/configure-oidc-azure">GitHub Actions から OpenID Connect で Azure に接続する設定の自動化方法</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/handson-rag-app">Azure 上で作る RAG アプリ開発入門</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/graph-api-summary">Microsoft Graph API 関連情報のまとめ</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/aoai-private-endpoint-managed-id">AOAI にプライベートエンドポイントから接続し、VM のマネージド ID を利用して API Key 無しで AOAI を呼び出す</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/handson-baseline-environment-on-azure-bicep">ks6088ts-labs/baseline-environment-on-azure-bicep のハンズオン</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Terraform provider for SORACOM を作って Azure Functions と連携してみた</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-12-10T00:00:00.000Z" itemprop="datePublished">2022年12月10日</time> · <!-- -->約27分</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/ks6088ts" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/ks6088ts.png" alt="ks6088ts"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/ks6088ts" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">ks6088ts</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer / Solutions Architect</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>Terraform で SORACOM のリソース管理をしたかったので、SORACOM 向けの Terraform カスタムプロバイダを実装してみました。カスタムプロバイダ開発に係る知見や、Terraform provider for SORACOM で SORACOM のリソース管理をしてみた例をご紹介します。  </p><ol><li>Terraform のカスタムプロバイダの概要</li><li>SORACOM 向けカスタムプロバイダの実装</li><li>SORACOM x Azure Functions の利用例</li></ol><p>といった章立てでまとめてみます。</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-terraform-のカスタムプロバイダの概要"><strong>1. Terraform のカスタムプロバイダの概要</strong><a href="#1-terraform-のカスタムプロバイダの概要" class="hash-link" aria-label="1-terraform-のカスタムプロバイダの概要 への直接リンク" title="1-terraform-のカスタムプロバイダの概要 への直接リンク">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-iac-"><strong>Why IaC ?</strong><a href="#why-iac-" class="hash-link" aria-label="why-iac- への直接リンク" title="why-iac- への直接リンク">​</a></h3><p>そもそもなぜ IaC が必要なのか？というところから、私の過去の経験を元に整理してみます。  </p><p>新しいものはたいてい怖いもので、初見では <code>「ウェブコンソールとか CLI ツールで十分でしょ？IaC ツールっていらなくないですか？」</code> といった気持ちでした。<br>
<!-- -->確かに CLI ツールは何かのリソースの操作や状態の確認などの目的で手軽に利用できて便利です。CLI ツールを駆使したシェルスクリプトでも IaC ツールで実施しているようなリソース管理を &quot;技術的には&quot; 実現できるかもしれません。<br>
<!-- -->実際に CLI でリソースの管理をしようとすると、手続き的な処理を書くことになります。リソースの差分チェックや個々の処理のエラーハンドリングなど、実は厳密にやろうとすると考慮することが多くてなかなか大変です。結果、複雑でメンテナンスが困難なスクリプトが出来上がったりします。<br>
<!-- -->とまぁここまで手を動かしてみてようやく重い腰を上げて IaC ツールを触ってみるか、ということになりました。実際に使ってみると、CLI で考慮する必要のあった差分チェックやらエラーハンドリングといった複雑さをツールが丸っと面倒を見てくれるおかげで、望ましいリソースの状態を宣言的に記述してツールに喰わせるだけになるのです。リソース設定を環境の再現性をもたせて移管するといったことも簡単になります。開発者体験が飛躍的に進歩した感じがします。<br>
<!-- -->IaC ツールがこれだけ便利だと、いついかなる時も IaC がしたくなる病に駆られてちょっとした検証とかで IaC するオーバーエンジニアリングをした時期もありました。<a href="https://www.google.com/search?q=Typescript%E4%BE%9D%E5%AD%98%E3%81%AE%E6%82%AA%E5%BE%AA%E7%92%B0&amp;sxsrf=ALiCzsbbYTvTMh39om3QUsgRGj7nvS3Z4w:1668426679347&amp;source=lnms&amp;tbm=isch&amp;sa=X&amp;ved=2ahUKEwj7iLncza37AhVZmFYBHe94BKoQ_AUoAXoECBkQAw&amp;biw=1080&amp;bih=1724&amp;dpr=1" target="_blank" rel="noopener noreferrer">TypeScript依存の悪循環</a> を想起しますね。<br>
<!-- -->IaC 化するにも作業コストがかかるので、<code>他者と協業する</code>とか<code>構築するシステムが大規模・複雑</code>になってきたときに、IaC を検討するとバランスが良いかと思います。</p><ul><li>CLI はあくまでワンショットのタスクの実行といった <code>動的な操作</code> を支援するツール</li><li>IaC ツールはリソースの構築といった<code>静的な操作</code>を支援するツール</li></ul><p>という認識を持って、用法容量を守って正しく使い分けるのが良さそうです。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="terraform-って何"><strong>Terraform って何？</strong><a href="#terraform-って何" class="hash-link" aria-label="terraform-って何 への直接リンク" title="terraform-って何 への直接リンク">​</a></h3><p>IaC ツールとしてカテゴライズされるソフトウェアとしては、<a href="https://aws.amazon.com/jp/cdk/" target="_blank" rel="noopener noreferrer">AWS CDK</a>・<a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a>・<a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/bicep/overview?tabs=bicep" target="_blank" rel="noopener noreferrer">Bicep</a> などがあります。<br>
<!-- -->中でも Terraform は、カスタムプロバイダと呼ばれる pluggable なインタフェースが存在していて、カスタムプロバイダを実装しさえすれば API を公開している Web サービスに対してリソースのプロビジョニングが可能になります。<br>
<!-- -->AWS, Azure, GCP などのクラウドサービスはもちろんのこと、既に数多くのカスタムプロバイダが <a href="https://registry.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform Registry</a> に公開されています。使いたいサービス向けのプロバイダが無いか検索してみると面白いです。</p><hr><h3 class="anchor anchorWithStickyNavbar_LWe7" id="カスタムプロバイダの開発に役立つ資料"><strong>カスタムプロバイダの開発に役立つ資料</strong><a href="#カスタムプロバイダの開発に役立つ資料" class="hash-link" aria-label="カスタムプロバイダの開発に役立つ資料 への直接リンク" title="カスタムプロバイダの開発に役立つ資料 への直接リンク">​</a></h3><p>カスタムプロバイダの実装に関して、私が読んで参考になった資料を紹介します。  </p><ul><li><strong><a href="https://developer.hashicorp.com/terraform/intro" target="_blank" rel="noopener noreferrer">HashiCorp / What is Terraform?</a></strong><ul><li>まずは一次情報にあたるのが賢明です。HashiCorp 公式の情報はかなり整理されていて読みやすいです。</li></ul></li><li><strong><a href="https://developer.hashicorp.com/terraform/tutorials/providers" target="_blank" rel="noopener noreferrer">Call APIs with Custom SDK Providers</a></strong><ul><li>とりあえず作ってみて<code>完全に理解した</code>状態になるためには、こちらのチュートリアルを一周するのがおすすめです。カスタムプロバイダの実装から、Terraform Registry に公開までキャッチアップできます。リリースパイプラインを GitHub Actions で構築する手順なんかも再利用性が高くて秀逸です。  </li></ul></li><li><strong><a href="https://amzn.to/3fPfHuW" target="_blank" rel="noopener noreferrer">エキスパートたちのGo言語</a></strong><ul><li>これまで全部英語の文献を紹介しましたが、「いやいや、日本語が良いんだけど...」という方もご安心を。<code>エキスパートたちのGo言語: 3.5 Custom Terraform Provider によるプロビジョニングの自動化</code> にもカスタムプロバイダの作り方が書いてあります。</li></ul></li></ul><hr><p>ここまで記事を一通り読めば、「カスタムプロバイダなんとなく実装できそう」な状態になります。いざ開発を進めてみると、</p><ul><li>具体的にどんな単位で責務を分割してパッケージに落とし込むか</li><li>CI/CD などのパイプラインってどう構築したらいいのだろうか</li></ul><p>といった悩みが出てくるケースもあるかと思います。そんな時は既存のカスタムプロバイダの実装の中に答えがあります。例えば <a href="https://github.com/hashicorp/terraform-provider-aws" target="_blank" rel="noopener noreferrer">hashicorp/terraform-provider-aws</a> では、</p><ul><li><code>internal/conns</code> 以下でクライアントオブジェクト周りを集約</li><li><code>internal/service</code> 配下に各種リソースをハンドルするパッケージを配置</li></ul><p>といった構成になっています。「authentication 周りは conns パッケージに集約する」とか「service パッケージ以下でサービスの追加機能を横に拡張していく」といった参考になる設計が多々ありました。どんな形であれ設計レベルで暗黙の前提が決まっていると実装方法が一意になり、開発の生産性を上げてくれるので予め決めておくとよいと思います。</p><p>CI/CD については、上で言及した HashiCorp さんのチュートリアル記事 <a href="https://developer.hashicorp.com/terraform/tutorials/providers/provider-release-publish" target="_blank" rel="noopener noreferrer">Release and Publish a Provider to the Terraform Registry</a> に、<code>Git tag を打つと GitHub Actions で release ジョブが回って Terraform Registry に自動的に公開される</code> パイプラインの記述があり非常に参考になりました。最終的に Terraform Registry への公開も想定すると、いろんなプラットフォーム向けにバイナリを生成する必要が出てきます。いちいち温かみのある手作業をしていると日が暮れてしまいますので、<a href="https://github.com/goreleaser/goreleaser-action" target="_blank" rel="noopener noreferrer">goreleaser/goreleaser-action</a> を活用してリリースパイプラインを GitHub Actions で構築しておくと良いです。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-クライアントを作る"><strong>API クライアントを作る</strong><a href="#api-クライアントを作る" class="hash-link" aria-label="api-クライアントを作る への直接リンク" title="api-クライアントを作る への直接リンク">​</a></h3><p>既存のカスタムプロバイダの実装をいくつか見るとわかることですが、カスタムプロバイダの実装には原則的に API コールのための実装詳細は含まれていません。いずれも API クライアントライブラリ or SDK に実装詳細を抱え込んでもらって、provider はそれを利用するアプリケーションとしての構成になっています。<br>
<!-- -->Terraform plugin がどのように動作するのかの概略図は以下の通りです。HashiCorp 社の資料でもクライアントライブラリとして切り離す設計を推奨しています。  </p><p><img loading="lazy" src="https://content.hashicorp.com/api/assets?product=tutorials&amp;version=main&amp;asset=public%2Fimg%2Fterraform%2Fproviders%2Fcore-plugins-api.png" alt="Overview" class="img_ev3q"></p><p>!!! tip
Tip: We recommend Terraform plugins consume an external API client library, as shown in the diagram above. If one doesn&#x27;t exist, you should create one. This is aligned with modern coding practices of keeping software projects modular.<br>
<!-- -->出典: <a href="https://developer.hashicorp.com/terraform/tutorials/configuration-language/provider-use?in=terraform%2Fconfiguration-language&amp;utm_offer=ARTICLE_PAGE#terraform-plugins" target="_blank" rel="noopener noreferrer">Perform CRUD Operations with Providers / Terraform plugins</a></p><p>なお、HashiCorp 提供の plugin ライブラリが Go で書かれているので、クライアントライブラリの言語も Go がよいです。</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-soracom-向けカスタムプロバイダの実装"><strong>2. SORACOM 向けカスタムプロバイダの実装</strong><a href="#2-soracom-向けカスタムプロバイダの実装" class="hash-link" aria-label="2-soracom-向けカスタムプロバイダの実装 への直接リンク" title="2-soracom-向けカスタムプロバイダの実装 への直接リンク">​</a></h2><p>SORACOM は SORACOM Funk, SORACOM Funnel といった各種クラウドプロバイダと簡単に接続するアプリケーションサービスを提供しています。SORACOM が Terraform 対応するとこれまで手動でやっていた諸々の連携設定作業をすべて Terraform で完結できるようになって便利なのでは？と妄想が膨らみ、今回 SORACOM 向けにカスタムプロバイダを開発するに至りました。</p><p>カスタムプロバイダ本体は Terraform Registry の <a href="https://registry.terraform.io/providers/ks6088ts/soracom/latest" target="_blank" rel="noopener noreferrer">ks6088ts/soracom</a> に公開済ですのですぐに触れる状態です。2022/12月時点で 1000 回近くダウンロードされているようです。まだまだ工事中なポイントが多々ありまして、機能が足りてなかったりドキュメントが手薄だったりしているので contribution は大歓迎です。<br>
<!-- -->基本的には <a href="https://github.com/ks6088ts/terraform-provider-soracom/tree/main/examples" target="_blank" rel="noopener noreferrer">examples</a> を実行していただくと雰囲気がつかめるはずです。<br>
<!-- -->SORACOM 向けの Terraform Provider の実装作業として、大きく 2 つのソフトウェア開発をしました。</p><ul><li>Step 1. API クライアントライブラリ <a href="https://github.com/ks6088ts/soracom-sdk-go" target="_blank" rel="noopener noreferrer">ks6088ts/soracom-sdk-go</a> の開発</li><li>Step 2. カスタムプロバイダ本体 <a href="https://github.com/ks6088ts/terraform-provider-soracom" target="_blank" rel="noopener noreferrer">ks6088ts/terraform-provider-soracom</a> の開発</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-api-クライアントライブラリの開発"><strong>Step 1. API クライアントライブラリの開発</strong><a href="#step-1-api-クライアントライブラリの開発" class="hash-link" aria-label="step-1-api-クライアントライブラリの開発 への直接リンク" title="step-1-api-クライアントライブラリの開発 への直接リンク">​</a></h3><p>OpenAPI v3 に対応した <a href="https://users.soracom.io/ja-jp/tools/api/reference/" target="_blank" rel="noopener noreferrer">SORACOM API リファレンス</a> が公開されていますので、このスキーマファイルから機械的に Go のクライアントライブラリを生成してみましょう。<br>
<!-- -->たった 2 steps です。</p><p>1．スキーマファイル <a href="https://users.soracom.io/swagger/soracom-api.ja.yaml" target="_blank" rel="noopener noreferrer">soracom-api.ja.yaml</a> をダウンロードして、<code>specs/api.yaml</code> に置きます。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -sSfL https://users.soracom.io/swagger/soracom-api.ja.yaml --output specs/api.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2．<a href="https://openapi-generator.tech/" target="_blank" rel="noopener noreferrer">OpenAPI Generator</a> を使って 1 でダウンロードした仕様書から下記コマンドを実行しクライアントライブラリを生成します。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">npx @openapitools/openapi-generator-cli generate </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --input-spec specs/api.yaml </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --generator-name go </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --output generated/api </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --package-name api </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --git-host github.com </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --git-user-id ks6088ts </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --git-repo-id soracom-sdk-go </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --http-user-agent ks6088ts/soracom-sdk-go/0.0.3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>コマンドラインオプションを見ていただくと、結構柔軟に所望の設定を注入することが出来ます。<br>
<!-- -->ここでは user agent やパッケージ名を好みの設定にしてコード生成しています。<br>
<code>generated/api</code> 以下に *.go ファイルが生成されれば成功です。ここで生成されたライブラリは <a href="https://github.com/ks6088ts/soracom-sdk-go" target="_blank" rel="noopener noreferrer">ks6088ts/soracom-sdk-go</a> で公開しています。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="github-actions-を使ってクライアントライブラリの-ci-をまわしてみる">GitHub Actions を使ってクライアントライブラリの CI をまわしてみる<a href="#github-actions-を使ってクライアントライブラリの-ci-をまわしてみる" class="hash-link" aria-label="GitHub Actions を使ってクライアントライブラリの CI をまわしてみる への直接リンク" title="GitHub Actions を使ってクライアントライブラリの CI をまわしてみる への直接リンク">​</a></h4><p>自動生成したクライアントライブラリは割とすぐ使えましたが、念のためライブラリの単体テストもしておきます。私は commit をトリガーとして、クライアントライブラリの E2E テストを GitHub Actions で実行するようにしています。</p><p>自動生成したライブラリを使って CI インフラ上で API コールするテストを実施するためには、認証情報(SORACOM でいうと auth key, auth key id)を渡す必要があります。認証キーは当然秘匿する必要がありますので、GitHub の Encrypted secrets を利用します。手順は <a href="https://docs.github.com/en/actions/security-guides/encrypted-secrets" target="_blank" rel="noopener noreferrer">GitHub Docs / Encrypted secrets</a> に書かれています。GitHub 側の設定が終われば、以下のような形で参照するだけです。
<code>.github/workflows/</code> に <a href="https://github.com/ks6088ts/soracom-sdk-go/blob/main/.github/workflows/test.yml" target="_blank" rel="noopener noreferrer">test.yml</a> を置くだけで CI が回ります。便利な世の中になったものですね。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">.github/workflows/test.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 一部を抜粋</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Run CI test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> make ci</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test GOPATH=/home/runner/go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">SORACOM_AUTH_KEY</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.SORACOM_AUTH_KEY </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">SORACOM_AUTH_KEY_ID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.SORACOM_AUTH_KEY_ID </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">COVERAGE_TYPE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.COVERAGE_TYPE </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="テスト用の-soracom-認証キーの権限は最小に">テスト用の SORACOM 認証キーの権限は最小に<a href="#テスト用の-soracom-認証キーの権限は最小に" class="hash-link" aria-label="テスト用の SORACOM 認証キーの権限は最小に への直接リンク" title="テスト用の SORACOM 認証キーの権限は最小に への直接リンク">​</a></h4><p>SORACOM では SAM ユーザというリソースに対して API の実行権限を制御したキーを払いだすことができます。SAM ユーザの権限設定方法は <a href="https://users.soracom.io/ja-jp/docs/sam/permission/#" target="_blank" rel="noopener noreferrer">SORACOM User ドキュメント / 権限設定のためのパーミッション構文</a>を参照ください。<br>
<!-- -->セキュリティリスクを最小限にするためにも権限は必要最低限のものにします。実リソースに対する細かい操作を CI で実行することに懸念がある場合は、検証を目的として使える <a href="https://users.soracom.io/ja-jp/tools/api-sandbox/" target="_blank" rel="noopener noreferrer">SORACOM API Sandbox</a> を使ってもよいかもしれません。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-カスタムプロバイダ本体の開発"><strong>Step 2. カスタムプロバイダ本体の開発</strong><a href="#step-2-カスタムプロバイダ本体の開発" class="hash-link" aria-label="step-2-カスタムプロバイダ本体の開発 への直接リンク" title="step-2-カスタムプロバイダ本体の開発 への直接リンク">​</a></h3><p>まずは、ユーザが触る HCL の外部仕様を設計することから開発を始めます。<br>
<!-- -->基本的には、対象となるクラウドプロバイダの API そのものと一対一対応させたスキーマを定義することが多いです。ただ、場合によってはカスタムプロバイダの外部仕様として露出すべきではないパラメータがある場合があります。のちの使い勝手や後方互換性担保のことを考えて、利用者観点で不要なものは削除して必要十分なインタフェースになるまでダイエットさせると小回りが利く仕様に収束すると思います。  </p><p>外部仕様の設計をしていく中で、<strong>依存関係にある複数のリソースの関係をどう表現するか</strong> というところも少し悩みました。<br>
<!-- -->例えばリソース A とリソース B が依存関係にあることを表現するにはどうすればよいか？といった点です。<br>
<!-- -->実はこの手の悩みも既に解決されていて、クラウドサービスの世界でよく見かける「リソース A をリソース B にアタッチするリソース C」を新たに定義することが多いようです。プロビジョニング対象のウェブサービスには C というリソースの物理的な実体はないのですが、カスタムプロバイダの外部仕様においてのみ存在する仮想的なリソース C を定義することで、A と B が直接依存関係を持たないようにするのです。<br>
<code>e.g. aws_internet_gateway_attachment, azurerm_virtual_machine_data_disk_attachment</code></p><p>ドキュメントに関しては、<a href="https://github.com/hashicorp/terraform-plugin-docs" target="_blank" rel="noopener noreferrer">tfplugindocs</a> を使うとカスタムプロバイダの Go のコードからドキュメントが生成され、<strong>コードとドキュメントが同期</strong> されます。<br>
<!-- -->ドキュメントの更新は忘れがちなので、CI 上でドキュメント生成して commit 済みのドキュメントと diff を取るなどして、仕組みでヒューマンエラーを撲滅するアクションを採ると精神衛生上良いです。私は CI パイプラインの中に <a href="https://github.com/ks6088ts/terraform-provider-soracom/blob/main/terraform.mk#L26" target="_blank" rel="noopener noreferrer">docs-diff</a> コマンドにあるような形で、CI 上でドキュメント生成処理を実行したあと git diff を実行して更新忘れを検知するようにしてみました。</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-soracom-funk-x-azure-functions-の利用例"><strong>3. SORACOM Funk x Azure Functions の利用例</strong><a href="#3-soracom-funk-x-azure-functions-の利用例" class="hash-link" aria-label="3-soracom-funk-x-azure-functions-の利用例 への直接リンク" title="3-soracom-funk-x-azure-functions-の利用例 への直接リンク">​</a></h2><p>最後に、SORACOM Funk と Azure Functions の連携を Terraform で構築したサンプルを紹介します。サンプルコードは <a href="https://github.com/ks6088ts/terraform-provider-soracom/tree/main/examples/group_configuration_funk_azure_functions_python" target="_blank" rel="noopener noreferrer">group_configuration_funk_azure_functions_python</a> にあります。<br>
<!-- -->構成図は以下の通りです。</p><p><img loading="lazy" alt="group_configuration_funk_azure_functions_python" src="/assets/images/group_configuration_funk_azure_functions_python-6829a8af601072972e5dcbf5abab3d1e.svg" width="1000" height="640" class="img_ev3q"></p><p>実行にはSORACOM の認証情報のセットアップと、Azure の認証情報のセットアップが必要になります。アカウントのセットアップやリソースの設定などは各社ユーザサイトを参照してください。</p><ul><li><a href="https://users.soracom.io/ja-jp/tools/cli/getting-started/#%E3%82%B9%E3%83%86%E3%83%83%E3%83%97-2-%E8%AA%8D%E8%A8%BC%E6%83%85%E5%A0%B1%E3%82%92%E6%BA%96%E5%82%99%E3%81%99%E3%82%8B" target="_blank" rel="noopener noreferrer">SORACOM CLI をインストールする / ステップ 2: 認証情報を準備する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/developer/terraform/authenticate-to-azure?tabs=bash" target="_blank" rel="noopener noreferrer">Azure に対して Terraform を認証する</a></li></ul><p>以下の操作でインフラリソースが構築/削除ができます。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># サンプルコードの取得</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone git@github.com:ks6088ts/terraform-provider-soracom.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> terraform-provider-soracom/examples/group_configuration_funk_azure_functions_python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># リソースの構築</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform apply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># リソースの削除</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform destroy -auto-approve</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="azure-のリソース">Azure のリソース<a href="#azure-のリソース" class="hash-link" aria-label="Azure のリソース への直接リンク" title="Azure のリソース への直接リンク">​</a></h3><ul><li>リソースグループ</li><li>ストレージアカウント</li><li>サービスプラン</li><li>関数アプリ</li></ul><p>を生成します。サンプルコードは以下の通りです。</p><div class="language-tf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">azure.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;azurerm&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  features {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_resource_group&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name     = &quot;${var.azure_prefix}-rg&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location = var.azure_resource_location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_storage_account&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                     = &quot;${var.azure_prefix}storageacct&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name      = azurerm_resource_group.example.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location                 = azurerm_resource_group.example.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account_tier             = &quot;Standard&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account_replication_type = &quot;LRS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_service_plan&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = &quot;${var.azure_prefix}-sp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location            = azurerm_resource_group.example.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.example.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  os_type             = &quot;Linux&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sku_name            = &quot;S1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_linux_function_app&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = &quot;${var.azure_prefix}exampleapp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location            = azurerm_resource_group.example.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.example.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  service_plan_id     = azurerm_service_plan.example.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storage_account_name       = azurerm_storage_account.example.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storage_account_access_key = azurerm_storage_account.example.primary_access_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  site_config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    application_stack {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      python_version = &quot;3.9&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_function_app_function&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name            = &quot;example-python-function&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function_app_id = azurerm_linux_function_app.example.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  language        = &quot;Python&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name    = &quot;__init__.py&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content = file(&quot;./app/__init__.py&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  test_data = jsonencode({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot; = &quot;Azure&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config_json = jsonencode({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;scriptFile&quot; = &quot;__init__.py&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;bindings&quot; = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;authLevel&quot; = &quot;function&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;direction&quot; = &quot;in&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;methods&quot; = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;get&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;post&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;name&quot; = &quot;req&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot; = &quot;httpTrigger&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;direction&quot; = &quot;out&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;name&quot;      = &quot;$return&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;type&quot;      = &quot;http&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;azurerm_function_app_host_keys&quot; &quot;example&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = &quot;${var.azure_prefix}exampleapp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.example.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # https://github.com/hashicorp/terraform-provider-azurerm/issues/9869</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    azurerm_linux_function_app.example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="soracom-のリソース">SORACOM のリソース<a href="#soracom-のリソース" class="hash-link" aria-label="SORACOM のリソース への直接リンク" title="SORACOM のリソース への直接リンク">​</a></h3><ul><li>SIM グループ</li><li>認証情報</li><li>SORACOM Funk の設定</li></ul><p>を生成します。認証情報と SORACOM Funk の設定には、上述した Azure 側のリソース設定を反映させて連携します。</p><div class="language-tf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">soracom.tf</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-tf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">terraform {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required_providers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    soracom = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source = &quot;ks6088ts/soracom&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;soracom&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  profile = var.soracom_profile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;soracom_group&quot; &quot;group&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = var.soracom_group_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;soracom_credentials&quot; &quot;credentials&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  credentials_id = var.credentials_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description    = &quot;API Token credentials via terraform-provider-soracom&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type           = &quot;api-token-credentials&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  credentials = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Azure Functions の設定を参照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    token = data.azurerm_function_app_host_keys.example.default_function_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;soracom_group_configuration_funk&quot; &quot;group_configuration_funk&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  group_id       = soracom_group.group.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled        = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  credentials_id = soracom_credentials.credentials.credentials_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  content_type   = &quot;json&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Azure Functions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destination {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    provider     = &quot;azure&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service      = &quot;function-app&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Azure Functions の呼び出し URL を参照</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resource_url = azurerm_function_app_function.example.invocation_url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上でサンプルの紹介は終了です。</p><p>これまでは Azure のリソースを作成してパラメータ設定を確認したあと、SORACOM 側の認証情報と SORACOM Funk の SIM グループの設定をウェブコンソールか SORACOM CLI で指定する必要がありました。Terraform 対応することで、そういった手作業も無くなり <code>terraform apply -auto-approve</code> すればサクッと Azure・SORACOM 双方を連携したリソースが生成できます。後片付けも <code>terraform destroy</code> でさっと終わります。より一層 SORACOM を便利に使うことができるようになりました。</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ポエム-ツール開発からの学び"><strong>ポエム: ツール開発からの学び</strong><a href="#ポエム-ツール開発からの学び" class="hash-link" aria-label="ポエム-ツール開発からの学び への直接リンク" title="ポエム-ツール開発からの学び への直接リンク">​</a></h2><p>この手のツールを開発してみて、改めて感じたことをポエム的に 2 点書き留めておきます。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-サンプルコードから書き始めること"><strong>1. サンプルコードから書き始めること</strong><a href="#1-サンプルコードから書き始めること" class="hash-link" aria-label="1-サンプルコードから書き始めること への直接リンク" title="1-サンプルコードから書き始めること への直接リンク">​</a></h3><p>今回実装したカスタムプロバイダや、API・SDK といった、プラットフォームを形成するためのソフトウェアに関して、一番注意を払うべきポイントは外部仕様であると思います。細かな内部実装上のバグなんかは都度直せますが、外部仕様は一度出すとクライアントに影響が出るため、容易に変更しづらいことが理由です。<br>
<!-- -->「なに当たり前のことを言っているんだ？」と思われる方もいらっしゃるかもしれません。しかしながら、依存する他のコンポーネントの仕様や内部実装上の制約などに気が向いてしまうと、それらに無意識的に引きずられてしまい最終的にユーザに提供する外部仕様がぎこちなくなることって意外と多くないでしょうか。カプセル化が不十分で不要なパラメータを晒したり、リソース間に不要な依存が発生していたり、直観的ではない操作を要求したり、、、少なくとも私はそういう失敗を何度もしました。こういった問題を踏んでは、<a href="https://amzn.to/3GgZt8x" target="_blank" rel="noopener noreferrer">C++のためのAPIデザイン</a> の <code>第2章 優れたAPIの特徴</code> に事細かに書いてある原理原則を何回も読み返したりしていました。</p><p>これまでの経験の中の学びの一つに、<strong>サンプルから書き始める(⇔外部仕様を先に策定する)</strong> ことがあります。これは常日頃意識するようにしています。<br>
<!-- -->サンプルコードから書き始めると、嫌でもユーザの利便性や後方互換性の考慮を最初にすることになります。実装上の制約といったノイズを排除して考えることもできます。仕様のちゃぶ台返しがあっても、内部実装に着手する前なら手戻りは少なくて済みます。最初にサンプルを書いておけば、後々ユーザから「サンプルください」なんてことも言われません。メリットのほうが多いのです。<br>
<!-- -->外部仕様の検討は、真面目にやると意外に時間がかかります。動作するコードとしての成果物がなかなか出てこない分、プログラマとしては焦燥感に駆られて実装に着手してしまうのも往々にしてあると思います。<br>
<!-- -->「意識しましょう」という努力目標のルールは大抵機能しないことが多いので、内部実装を始めるより前に API のレビューや(動作しない状態の)サンプルコードのレビューを必須とする開発フローを取り入れるのも、組織の規模や提供するソフトウェアの特性によってはフィットするのかもしれません。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-自分以外の視点で良いフィードバックをくれる人を見つけること"><strong>2. 自分以外の視点で良いフィードバックをくれる人を見つけること</strong><a href="#2-自分以外の視点で良いフィードバックをくれる人を見つけること" class="hash-link" aria-label="2-自分以外の視点で良いフィードバックをくれる人を見つけること への直接リンク" title="2-自分以外の視点で良いフィードバックをくれる人を見つけること への直接リンク">​</a></h3><p>個人開発をしていると、目線が一つだけになり結果的に良いものができないのを思い知りました。ある程度品質や方向性が固まった段階で、早期にできるだけいろんな人に dogfooding をお願いして、率直でストレートな意見をもらうことは非常に大事であると思いました。<br>
<!-- -->特に、知識豊富なヘビーユーザーや事前知識がそこまでないライトユーザーなど、様々な人にお願いすると面白いです。前者はセキュリティ上の懸念点を見つけてくださいましたし、後者は「サンプルみれば理解できるでしょ？」みたいなマッチョな思想がイケてないことを教えてくれたりと、他者からのフィードバックで多くの気づきと改善ができました。<br>
<!-- -->今回開発したカスタムプロバイダもそうした人達との協業を通して改善していった経緯もあります。改めてこの場を借りて感謝申し上げます。</p><p>(完)</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>タグ:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/terraform">terraform</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/azure">azure</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ブログ記事のナビゲーション"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/gh-pages-by-docusaurus"><div class="pagination-nav__sublabel">新しい記事</div><div class="pagination-nav__label">GitHub Pages by Docusaurus</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-terraform-のカスタムプロバイダの概要" class="table-of-contents__link toc-highlight"><strong>1. Terraform のカスタムプロバイダの概要</strong></a><ul><li><a href="#why-iac-" class="table-of-contents__link toc-highlight"><strong>Why IaC ?</strong></a></li><li><a href="#terraform-って何" class="table-of-contents__link toc-highlight"><strong>Terraform って何？</strong></a></li><li><a href="#カスタムプロバイダの開発に役立つ資料" class="table-of-contents__link toc-highlight"><strong>カスタムプロバイダの開発に役立つ資料</strong></a></li><li><a href="#api-クライアントを作る" class="table-of-contents__link toc-highlight"><strong>API クライアントを作る</strong></a></li></ul></li><li><a href="#2-soracom-向けカスタムプロバイダの実装" class="table-of-contents__link toc-highlight"><strong>2. SORACOM 向けカスタムプロバイダの実装</strong></a><ul><li><a href="#step-1-api-クライアントライブラリの開発" class="table-of-contents__link toc-highlight"><strong>Step 1. API クライアントライブラリの開発</strong></a></li><li><a href="#step-2-カスタムプロバイダ本体の開発" class="table-of-contents__link toc-highlight"><strong>Step 2. カスタムプロバイダ本体の開発</strong></a></li></ul></li><li><a href="#3-soracom-funk-x-azure-functions-の利用例" class="table-of-contents__link toc-highlight"><strong>3. SORACOM Funk x Azure Functions の利用例</strong></a><ul><li><a href="#azure-のリソース" class="table-of-contents__link toc-highlight">Azure のリソース</a></li><li><a href="#soracom-のリソース" class="table-of-contents__link toc-highlight">SORACOM のリソース</a></li></ul></li><li><a href="#ポエム-ツール開発からの学び" class="table-of-contents__link toc-highlight"><strong>ポエム: ツール開発からの学び</strong></a><ul><li><a href="#1-サンプルコードから書き始めること" class="table-of-contents__link toc-highlight"><strong>1. サンプルコードから書き始めること</strong></a></li><li><a href="#2-自分以外の視点で良いフィードバックをくれる人を見つけること" class="table-of-contents__link toc-highlight"><strong>2. 自分以外の視点で良いフィードバックをくれる人を見つけること</strong></a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/category/projects">Projects</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/privacy-policy">Privacy Policy</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/ks6088ts" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/ks6088ts" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/ks6088ts" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 ks6088ts. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.7b63d5b9.js"></script>
<script src="/assets/js/main.c82f993f.js"></script>
</body>
</html>
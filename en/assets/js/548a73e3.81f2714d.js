"use strict";(self.webpackChunkks_6088_ts_github_io=self.webpackChunkks_6088_ts_github_io||[]).push([[6751],{5680:(e,n,t)=>{t.d(n,{xA:()=>u,yg:()=>g});var a=t(6540);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function p(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),s=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},u=function(e){var n=s(e.components);return a.createElement(l.Provider,{value:n},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},h=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,u=p(e,["components","mdxType","originalType","parentName"]),c=s(t),h=r,g=c["".concat(l,".").concat(h)]||c[h]||d[h]||i;return t?a.createElement(g,o(o({ref:n},u),{},{components:t})):a.createElement(g,o({ref:n},u))}));function g(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=h;var p={};for(var l in n)hasOwnProperty.call(n,l)&&(p[l]=n[l]);p.originalType=e,p[c]="string"==typeof e?e:r,o[1]=p;for(var s=2;s<i;s++)o[s]=t[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}h.displayName="MDXCreateElement"},840:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>p,toc:()=>s});var a=t(8168),r=(t(6540),t(5680));const i={slug:"fork-azure-openai-playground-en",title:"Building a ChatGPT trial environment using Azure OpenAI Service",authors:"ks6088ts",tags:["azure","azure-ad","azure-openai-service","app-service"]},o=void 0,p={permalink:"/en/blog/fork-azure-openai-playground-en",source:"@site/blog/2023-05-01-fork-azure-openai-playground.en/index.md",title:"Building a ChatGPT trial environment using Azure OpenAI Service",description:"* This article is translated from Azure OpenAI Service \u3092\u5229\u7528\u3057\u305f ChatGPT \u304a\u8a66\u3057\u74b0\u5883\u306e\u69cb\u7bc9",date:"2023-05-01T00:00:00.000Z",formattedDate:"May 1, 2023",tags:[{label:"azure",permalink:"/en/blog/tags/azure"},{label:"azure-ad",permalink:"/en/blog/tags/azure-ad"},{label:"azure-openai-service",permalink:"/en/blog/tags/azure-openai-service"},{label:"app-service",permalink:"/en/blog/tags/app-service"}],readingTime:7.42,hasTruncateMarker:!0,authors:[{name:"ks6088ts",title:"Software Engineer / Solutions Architect",url:"https://github.com/ks6088ts",imageURL:"https://github.com/ks6088ts.png",key:"ks6088ts"}],frontMatter:{slug:"fork-azure-openai-playground-en",title:"Building a ChatGPT trial environment using Azure OpenAI Service",authors:"ks6088ts",tags:["azure","azure-ad","azure-openai-service","app-service"]},prevItem:{title:"Azure OpenAI Service \u3092\u5229\u7528\u3057\u305f ChatGPT \u304a\u8a66\u3057\u74b0\u5883\u306b\u30ed\u30b0\u51fa\u529b\u6a5f\u80fd\u3092\u8ffd\u52a0\u3059\u308b",permalink:"/en/blog/aoai-apim-easyauth"},nextItem:{title:"Azure OpenAI Service \u3092\u5229\u7528\u3057\u305f ChatGPT \u304a\u8a66\u3057\u74b0\u5883\u306e\u69cb\u7bc9",permalink:"/en/blog/fork-azure-openai-playground"}},l={authorsImageUrls:[void 0]},s=[{value:"Overview",id:"overview",level:2},{value:"Hands on",id:"hands-on",level:2},{value:"1. Create Azure OpenAI Service resource",id:"1-create-azure-openai-service-resource",level:3},{value:"2. Develop a Chat app",id:"2-develop-a-chat-app",level:3},{value:"3. Deploy to App Service",id:"3-deploy-to-app-service",level:3},{value:"4. Add authentication to the web app running on App Service",id:"4-add-authentication-to-the-web-app-running-on-app-service",level:3},{value:"5. Add private endpoint settings",id:"5-add-private-endpoint-settings",level:3},{value:"6. Add VNet integration settings for App Service",id:"6-add-vnet-integration-settings-for-app-service",level:3},{value:"Summary",id:"summary",level:2}],u={toc:s},c="wrapper";function d(e){let{components:n,...i}=e;return(0,r.yg)(c,(0,a.A)({},u,i,{components:n,mdxType:"MDXLayout"}),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"This article is translated from ",(0,r.yg)("a",{parentName:"li",href:"/blog/fork-azure-openai-playground"},"Azure OpenAI Service \u3092\u5229\u7528\u3057\u305f ChatGPT \u304a\u8a66\u3057\u74b0\u5883\u306e\u69cb\u7bc9"))),(0,r.yg)("hr",null),(0,r.yg)("p",null,"We have created a trial environment for ChatGPT using Azure OpenAI Service.",(0,r.yg)("br",{parentName:"p"}),"\n","Both OpenAI and Azure OpenAI Service already have easy-to-use web apps for experiencing ChatGPT, and all you need is a browser and an account to try it out."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"OpenAI: ",(0,r.yg)("a",{parentName:"li",href:"https://chat.openai.com/"},"ChatGPT Web App"),", ",(0,r.yg)("a",{parentName:"li",href:"https://platform.openai.com/playground"},"Playground")),(0,r.yg)("li",{parentName:"ul"},"Azure: ",(0,r.yg)("a",{parentName:"li",href:"https://oai.azure.com/portal"},"Azure OpenAI Studio"))),(0,r.yg)("p",null,"From the perspective of a personal trial, just using these web applications is sufficient.",(0,r.yg)("br",{parentName:"p"}),"\n","However, when considering the use case of trial use within a wide range of organizations with a view to business application, various issues arise."),(0,r.yg)("p",null,"For example, if you simply obtain an API Token and use it in a direct way, you cannot prevent unauthorized use when the API Token is leaked. Also, if you want to limit users to members of your organization, you will need to authenticate them in some way. If you tackle these issues from scratch, you will have less time to spend on the trial of ChatGPT, which is the original purpose of this project."),(0,r.yg)("p",null,"Therefore, this article introduces how to build a trial environment for OpenAI API using Azure OpenAI Service with sample code, with a view to using OpenAI API for business PoC."),(0,r.yg)("h2",{id:"overview"},"Overview"),(0,r.yg)("p",null,"The following diagram shows the architecture of the trial environment we will build."),(0,r.yg)("p",null,(0,r.yg)("img",{alt:"architecture",src:t(4264).A,width:"3497",height:"2282"})),(0,r.yg)("h2",{id:"hands-on"},"Hands on"),(0,r.yg)("p",null,"The following steps are required to build the trial environment."),(0,r.yg)("hr",null),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},"Create Azure OpenAI Service resource"),(0,r.yg)("li",{parentName:"ol"},"Develop a Chat app"),(0,r.yg)("li",{parentName:"ol"},"Deploy to App Service"),(0,r.yg)("li",{parentName:"ol"},"Add authentication to the web app running on App Service"),(0,r.yg)("li",{parentName:"ol"},"Add private endpoint settings"),(0,r.yg)("li",{parentName:"ol"},"Add VNET integration settings for App Service")),(0,r.yg)("hr",null),(0,r.yg)("p",null,"The following sections will walk you through these steps.\nWhen you are done, go to the App Service URL and try ChatGPT."),(0,r.yg)("h3",{id:"1-create-azure-openai-service-resource"},"1. Create Azure OpenAI Service resource"),(0,r.yg)("p",null,"See ",(0,r.yg)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/cognitive-services/openai/how-to/create-resource?pivots=cli"},"Create a resource and deploy a model using Azure OpenAI\n")," to create Azure OpenAI Service resource."),(0,r.yg)("p",null,"The ",(0,r.yg)("inlineCode",{parentName:"p"},"Azure OpenAI resource name"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"deployed model name"),", and ",(0,r.yg)("inlineCode",{parentName:"p"},"API key")," will be used later."),(0,r.yg)("h3",{id:"2-develop-a-chat-app"},"2. Develop a Chat app"),(0,r.yg)("p",null,"There are many necessary UI components such as chat forms for OpenAI and parameter setting UI for Playground, and writing a front-end app from scratch will take a lot of time.",(0,r.yg)("br",{parentName:"p"}),"\n","Since the implementation of a front-end app is not our goal, we will look for a good OSS to achieve our goal in the shortest time possible."),(0,r.yg)("p",null,"I sorted by Star count on GitHub and scoured some OSS, and could not find the exact app that uses the Azure OpenAI Service, but I did find ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/Nashex/gpt4-playground"},"Nashex/gpt4-playground"),", an OSS clone of OpenAI's Playground."),(0,r.yg)("p",null,"There is a demo site (",(0,r.yg)("a",{parentName:"p",href:"https://www.gpt4-playground.com/"},"GPT-4 Playground"),"), and it seems to be almost in line with the purpose of this project, except that it uses OpenAI's API.  "),(0,r.yg)("p",null,"If we fork this OSS and modify the code that calls OpenAI API to use Azure OpenAI Service, it should work easily.",(0,r.yg)("br",{parentName:"p"}),"\n","The following code is applicable."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-typescript",metastring:'title="gpt4-playground/src/utils/OpenAI/OpenAI.ts"',title:'"gpt4-playground/src/utils/OpenAI/OpenAI.ts"'},'  const response = await fetch("https://api.openai.com/v1/chat/completions", {\n    headers: {\n      Authorization: `Bearer ${token}`,\n      "Content-Type": "application/json",\n    },\n    method: "POST",\n    body: JSON.stringify(payload),\n  });\n')),(0,r.yg)("p",null,"By rewriting the ",(0,r.yg)("inlineCode",{parentName:"p"},"Authorization")," in the fetch destination url and request header to ",(0,r.yg)("inlineCode",{parentName:"p"},"api-key"),", the same functionality worked with Azure OpenAI Service.  "),(0,r.yg)("p",null,"Since I planned to deploy a Docker image in the final stage, I used environment variables to set confidential information such as ",(0,r.yg)("inlineCode",{parentName:"p"},"API KEY")," and resource names from the outside. ",(0,r.yg)("a",{parentName:"p",href:"https://nextjs.org/docs/basic-features/environment-variables"},"Next.js / Environment Variables\n"),"."),(0,r.yg)("p",null,"After confirming that it works in the local environment, write a Dockerfile to containerize it and push it to Docker Hub."),(0,r.yg)("p",null,"When creating the image, production build for the Next.js app should be applied and place the artifact into the image."),(0,r.yg)("p",null,"The source code of the forked and modified application is available at ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/ks6088ts-labs/azure-openai-playground"},"ks6088ts-labs/azure-openai-playground"),".  "),(0,r.yg)("p",null,"Please note that many parts of the source code have been modified in an ad-hoc manner for the purpose of quick implementation, so please use it only as a reference.  "),(0,r.yg)("p",null,"Docker images are available at ",(0,r.yg)("a",{parentName:"p",href:"https://hub.docker.com/r/ks6088ts/azure-openai-playground"},"ks6088ts/azure-openai-playground"),".  "),(0,r.yg)("p",null,"If you just want to run the service in local environment, you can check the service operation with the following command"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-shell"},'# run the following command and access to localhost:3000 with your browser\ndocker run --platform=linux/amd64 --rm \\\n    -p "3000:3000" \\\n    --env "AZURE_OPENAI_API_KEY=<YOUR API KEY>" \\\n    --env "AZURE_OPENAI_NAME=<YOUR AOAI NAME>" \\\n    --env "AZURE_OPENAI_DEPLOYMENT_NAME=<YOUR DEPLOYMENT NAME>" \\\n    --env "AZURE_OPENAI_API_VERSION=$(AZURE_OPENAI_API_VERSION)" \\\n    ks6088ts/azure-openai-playground:0.0.5\n')),(0,r.yg)("h3",{id:"3-deploy-to-app-service"},"3. Deploy to App Service"),(0,r.yg)("p",null,"The app implemented in step 2 will be published on the Azure App Service.\nIn this scenario, the Docker container image in the Docker Hub will be pulled and published to the App Service."),(0,r.yg)("p",null,"Execute the following commands in the Azure CLI."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-shell"},"# create resource group\naz group create \\\n    --name $RESOURCE_GROUP_NAME \\\n    --location japaneast\n\n# create App Service Plan\naz appservice plan create \\\n    --name $APP_SERVICE_PLAN_NAME \\\n    --resource-group $RESOURCE_GROUP_NAME \\\n    --location japaneast \\\n    --sku B1 \\\n    --is-linux\n\n# create App Service\naz webapp create \\\n    --name $APP_SERVICE_NAME \\\n    --plan $APP_SERVICE_PLAN_NAME \\\n    --resource-group $RESOURCE_GROUP_NAME \\\n    --deployment-container-image-name $CONTAINER_IMAGE_NAME\n\n# set environment variables for App Service\naz webapp config appsettings set \\\n    --name $APP_SERVICE_NAME \\\n    --resource-group $RESOURCE_GROUP_NAME \\\n    --settings \\\n        WEBSITES_PORT=3000 \\\n        AZURE_OPENAI_API_KEY=$AZURE_OPENAI_API_KEY \\\n        AZURE_OPENAI_NAME=$AZURE_OPENAI_NAME \\\n        AZURE_OPENAI_DEPLOYMENT_NAME=$AZURE_OPENAI_DEPLOYMENT_NAME \\\n        AZURE_OPENAI_API_VERSION=$AZURE_OPENAI_API_VERSION\n\n# restart App Service to reflect the environment variables\naz webapp restart \\\n    --name $APP_SERVICE_NAME \\\n    --resource-group $RESOURCE_GROUP_NAME\n")),(0,r.yg)("p",null,"Now, when you access the App Service URL, it should work the same way it did when you ran it locally earlier."),(0,r.yg)("h3",{id:"4-add-authentication-to-the-web-app-running-on-app-service"},"4. Add authentication to the web app running on App Service"),(0,r.yg)("p",null,"Since the App Service supports built-in authentication (=EasyAuth) and authorization, you can have users sign in without writing any code in your web app.",(0,r.yg)("br",{parentName:"p"}),"\n","For instructions, see ",(0,r.yg)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/app-service/scenario-secure-app-authentication-app-service"},"Tutorial: Add app authentication to your web app running on Azure App Service"),".",(0,r.yg)("br",{parentName:"p"}),"\n","Simply follow ",(0,r.yg)("inlineCode",{parentName:"p"},"AppService > Authentication > Add identity provider")," from the Azure Portal to add the desired authentication provider. The major authentication providers are supported, so it is easy to add authentication functionality."),(0,r.yg)("h3",{id:"5-add-private-endpoint-settings"},"5. Add private endpoint settings"),(0,r.yg)("p",null,"Configure Azure OpenAI Service to be available only for private network connections via Azure Virtual Network (VNet).\nBy limiting requests to those made via the private network, you can prevent unauthorized use of resources from outside, even in the unlikely event that the API Key is leaked.",(0,r.yg)("br",{parentName:"p"}),"\n","For instructions, please refer to ",(0,r.yg)("a",{parentName:"p",href:"https://blog.jbs.co.jp/entry/2023/04/07/173940"},"Azure OpenAI\u306b\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\uff08Private Endpoint\uff09\u3092\u8a2d\u5b9a\u3057\u3066\u6771\u65e5\u672c\u30ea\u30fc\u30b8\u30e7\u30f3\u306e\u4eee\u60f3\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u306e\u307f\u304b\u3089\u4f7f\u3046")," (*This article is in Japanese, unfortunately).\nFollowing the article, I performed the following operation from Azure Portal and confirmed that the API cannot be called from Azure OpenAI Playground, as expected."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Check ",(0,r.yg)("inlineCode",{parentName:"li"},"Azure OpenAI > Networking > Firewalls and virtual networks > Disabled")," and then activate Private Endpoint"),(0,r.yg)("li",{parentName:"ul"},"Create Private Endpoint from ",(0,r.yg)("inlineCode",{parentName:"li"},"Azure OpenAI > Networking > Private endpoint connections > + Private endpoint"))),(0,r.yg)("p",null,"Note that the network settings are not immediately reflected, so you need to wait a bit before checking. When I hurriedly checked, it was not reflected and I got stuck...",(0,r.yg)("br",{parentName:"p"}),"\n","To confirm content of the API response, you can simply use ",(0,r.yg)("inlineCode",{parentName:"p"},"curl")," to call the REST API."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-shell"},'curl "https://${AOAI_NAME}.openai.azure.com/openai/deployments/${MODEL_NAME}/completions?api-version=2022-12-01" \\\n  -H \'api-key: your-api-key\' \\\n  -H \'content-type: application/json\' \\\n  --data-raw \'{"prompt":"Write a product launch email for new AI-powered headphones that are priced at $79.99 and available at Best Buy, Target and Amazon.com. The target audience is tech-savvy music lovers and the tone is friendly and exciting.\\n\\n1. What should be the subject line of the email?  \\n2. What should be the body of the email?","temperature":1,"top_p":1,"frequency_penalty":0,"presence_penalty":0,"max_tokens":350,"stop":null,"stream":true}\' \\\n  --compressed -vvvv\n')),(0,r.yg)("p",null,"It seems that Private Endpoint is indeed enabled, since the following parameters were also found in the response."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"policy-id: ThrowExceptionDueToTrafficDenied")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},'{"error":{"code":"AccessDenied","message": "Public access is disabled. Please configure private endpoint."}}'))),(0,r.yg)("h3",{id:"6-add-vnet-integration-settings-for-app-service"},"6. Add VNet integration settings for App Service"),(0,r.yg)("p",null,"Enable VNet integration in the Outbound communication settings of the App Service and configure it to send requests from the App Service to the Azure OpenAI Service via VNet.\nRefer to ",(0,r.yg)("a",{parentName:"p",href:"https://techblog.ap-com.co.jp/entry/2021/03/12/150117"},"\u3010Azure\u3011App Service\u306eVNet\u7d71\u5408\u3068\u30d7\u30e9\u30a4\u30d9\u30fc\u30c8\u30ea\u30f3\u30af\u3092\u5229\u7528\u3057\u305f\u901a\u4fe1\u9589\u57df\u5316"),"(*This article is in Japanese, unfortunately) and set ",(0,r.yg)("inlineCode",{parentName:"p"},"AppService > Networking > Outbound Traffic > VNet integration > + Add VNet")," to add VNet."),(0,r.yg)("h2",{id:"summary"},"Summary"),(0,r.yg)("p",null,"After following the steps described in the article, the following behavior has been confirmed"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Unauthenticated users are redirected to the authentication screen of the given authentication provider"),(0,r.yg)("li",{parentName:"ul"},"Upon successful authentication, users can access to the web app"),(0,r.yg)("li",{parentName:"ul"},"Azure OpenAI Service responds to the text sent from the chat form"),(0,r.yg)("li",{parentName:"ul"},"API requests failed from Azure OpenAI Playground, which is outside the VNet")),(0,r.yg)("p",null,"This article summarizes the steps to use Azure OpenAI Service from the App Service.\nBy using the App Service's built-in authentication and Vnet integration, we were able to build a secure environment to use Azure OpenAI Service without any hassle."))}d.isMDXComponent=!0},4264:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/architecture-dcd49393a7522cc8d86ca946b46bf8af.png"}}]);